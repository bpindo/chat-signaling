<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Telegram Mesh Signaling â€“ DEBUG</title>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>

<style>
body {
  font-family: monospace;
  background:#f4f7fb;
  padding:16px;
}
button,input {
  width:100%;
  margin:6px 0;
  padding:8px;
}
pre {
  background:#0b1020;
  color:#9ef;
  padding:10px;
  height:260px;
  overflow:auto;
  white-space:pre-wrap;
}
</style>
</head>

<body>

<h3>Telegram Mesh Signaling (DEBUG)</h3>

<button onclick="createOffer()">âž• CREATE OFFER</button>

<input id="msg" placeholder="message">
<button onclick="broadcast()">SEND MESSAGE</button>

<pre id="log"></pre>

<script>
/* ================= CONFIG ================= */
const BOT_SEND = "8384730708:AAHjPCLYpW7wz2B5-jBxMJ17-kH1G1zXZuY";
const BOT_READ = "359218339:AAF7KH-T3ihEPvHfWPJge_Ax9PdV9GQw2W0";
const CHANNEL_ID = "-1003689025820";

/* ================= STATE ================= */
const myId = "anom" + Math.floor(Math.random()*9999);
const peers = {};
const state = {};
let lastUpdateId = 0;

/* ================= UI ================= */
const logEl = document.getElementById("log");
function log(m){
  logEl.textContent += `[${new Date().toLocaleTimeString()}] ${m}\n`;
  logEl.scrollTop = logEl.scrollHeight;
}

log("ðŸ†” myId = " + myId);

/* ================= TELEGRAM ================= */
async function sendEvent(event){
  log("ðŸ“¤ SEND â†’ TELEGRAM: " + event.kind + " " + event.connId);
  try {
    const res = await fetch(
      `https://api.telegram.org/bot${BOT_SEND}/sendMessage`,
      {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          chat_id: CHANNEL_ID,
          text: JSON.stringify(event)
        })
      }
    );
    const j = await res.json();
    log("ðŸ“¨ TELEGRAM RESP: " + JSON.stringify(j));
  } catch(e){
    log("âŒ TELEGRAM ERROR: " + e.message);
  }
}

async function pollEvents(){
  try {
    const res = await fetch(
      `https://api.telegram.org/bot${BOT_READ}/getUpdates?offset=${lastUpdateId+1}`
    );
    const data = await res.json();
    if(!data.result) return;

    for(const u of data.result){
      lastUpdateId = u.update_id;
      const msg = u.channel_post || u.message;
      if(!msg?.text) continue;

      try {
        const evt = JSON.parse(msg.text);
        reducer(evt);
      } catch {}
    }
  } catch(e){
    log("âŒ POLL ERROR: " + e.message);
  }
}

/* ================= REDUCER ================= */
function reducer(e){
  if(e.from === myId) return;
  if(Date.now() - e.ts > 120000) return;

  const cid = e.connId;

  if(e.kind === "offer"){
    if(state[cid]) return;

    log("ðŸ“¥ OFFER IN " + cid);
    const p = new SimplePeer({ initiator:false, trickle:false });
    setupPeer(p, cid, "receiver");
    p.signal(e.payload.sdp);
  }

  if(e.kind === "answer"){
    if(state[cid]?.role !== "initiator") return;

    log("ðŸ“¥ ANSWER IN " + cid);
    state[cid].peer.signal(e.payload.sdp);
  }
}

/* ================= PEER ================= */
function setupPeer(peer, connId, role){
  peers[connId] = peer;
  state[connId] = { peer, role };

  peer.on("signal", data=>{
    log("ðŸ“¡ SIGNAL GENERATED: " + data.type + " (" + connId + ")");

    sendEvent({
      v:1,
      kind: data.type,
      from: myId,
      to: "*",
      connId,
      ts: Date.now(),
      payload: { sdp: data }
    });
  });

  peer.on("connect", ()=>{
    log("âœ… CONNECTED " + connId);
  });

  peer.on("data", d=>{
    log("ðŸ’¬ DATA: " + d);
  });

  peer.on("close", ()=>{
    log("âš ï¸ CLOSED " + connId);
    cleanup(connId);
  });

  peer.on("error", e=>{
    log("âŒ PEER ERROR ("+connId+"): " + e.message);
  });
}

function cleanup(id){
  if(peers[id]){
    peers[id].destroy();
    delete peers[id];
    delete state[id];
  }
}

/* ================= ACTION ================= */
function createOffer(){
  const connId = "conn-" + crypto.randomUUID();
  log("â³ CREATE OFFER " + connId);

  const p = new SimplePeer({
    initiator:true,
    trickle:false
  });

  setupPeer(p, connId, "initiator");

  // penting untuk iOS / mobile
  setTimeout(()=>{
    log("âŒ› waiting signalâ€¦");
  }, 0);
}

function broadcast(){
  const t = document.getElementById("msg").value;
  for(const id in peers){
    if(peers[id].connected){
      peers[id].send(myId + ": " + t);
    }
  }
}

/* ================= LOOP ================= */
setInterval(pollEvents, 2000);
</script>

</body>
</html>