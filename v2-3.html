<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Multi-Peer Mesh Manual Signaling + Telegram</title>

<style>
  :root {
    --bg: #f4f7fb;
    --card: #ffffff;
    --border: #d0d7e2;
    --primary: #2563eb;
    --text: #1f2937;
    --muted: #6b7280;
  }

  body {
    font-family: system-ui, monospace;
    background: var(--bg);
    color: var(--text);
    padding: 20px;
    max-width: 760px;
    margin: auto;
  }

  h2 {
    margin-bottom: 20px;
    text-align: center;
  }

  .peer-section {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  strong {
    color: var(--primary);
    display: block;
    margin-bottom: 10px;
  }

  textarea, input {
    width: 100%;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    font-family: monospace;
    margin-bottom: 10px;
  }

  textarea[readonly] {
    background: #e5e7eb;
  }

  button {
    width: 100%;
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 14px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 6px;
  }

  button:hover {
    background: #1e40af;
  }

  #chatLog {
    background: #eee;
    padding: 10px;
    height: 140px;
    overflow-y: auto;
  }

  #systemLog {
    background: #0f172a;
    color: #e5e7eb;
    padding: 10px;
    height: 200px;
    overflow-y: auto;
  }

  #peerList {
    background:#eee;
    padding:10px;
    font-family: monospace;
  }
</style>
</head>

<body>

<h2>üåê Multi-Peer Mesh Manual Signaling</h2>

<div class="peer-section">
  <strong>1Ô∏è‚É£ Buat Offer</strong>
  <button onclick="createOffer()">Buat Offer</button>
</div>

<div class="peer-section">
  <strong>2Ô∏è‚É£ Apply Signaling</strong>
  <textarea id="signalInput" placeholder="Paste JSON di sini"></textarea>
  <button onclick="applySignal()">Apply</button>
</div>

<div class="peer-section">
  <strong>üì¶ Signaling JSON</strong>
  <textarea id="jsonLog" rows="6" readonly></textarea>
  <button id="copyJsonBtn">Copy JSON</button>
  <button onclick="sendJsonToTelegram()">Kirim ke Telegram</button>
</div>

<div class="peer-section">
  <strong>3Ô∏è‚É£ Broadcast Message</strong>
  <input id="messageInput" placeholder="Pesan">
  <button onclick="broadcast()">Kirim</button>
</div>

<div class="peer-section">
  <strong>üë• Peer List</strong>
  <div id="peerList"></div>
</div>

<div class="peer-section">
  <strong>üí¨ Chat</strong>
  <pre id="chatLog"></pre>
</div>

<div class="peer-section">
  <strong>üì° System Log</strong>
  <pre id="systemLog"></pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script>
/* ================= TELEGRAM CONFIG ================= */
const BOT_SEND = "8384730708:AAHjPCLYpW7wz2B5-jBxMJ17-kH1G1zXZuY";
const BOT_READ = "359218339:AAF7KH-T3ihEPvHfWPJge_Ax9PdV9GQw2W0";
const CHANNEL_ID = "-100g3689025820";

/* ================= STATE ================= */
const myId = 'anom' + Math.floor(1000 + Math.random()*9000);
const peers = {};
const peersMyId = {};

const systemLogEl = document.getElementById('systemLog');
const chatLogEl = document.getElementById('chatLog');
const jsonLogEl = document.getElementById('jsonLog');
const signalInput = document.getElementById('signalInput');
const peerListEl = document.getElementById('peerList');
const messageInput = document.getElementById('messageInput');

/* ================= UTIL ================= */
function logSystem(m){
  systemLogEl.textContent += m + "\n";
  systemLogEl.scrollTop = systemLogEl.scrollHeight;
}
function logChat(m){
  chatLogEl.textContent += m + "\n";
  chatLogEl.scrollTop = chatLogEl.scrollHeight;
}
function logJSON(o){
  jsonLogEl.value = JSON.stringify(o, null, 2);
}
function updatePeerList(){
  peerListEl.innerHTML = '';
  for(const k in peersMyId){
    peerListEl.innerHTML += `Peer ${peersMyId[k]} (${k})<br>`;
  }
}

/* ================= PEER ================= */
function createOffer(){
  const connId = 'conn-' + crypto.randomUUID();
  const p = new SimplePeer({ initiator:true, trickle:false });
  setupPeer(p, connId);
  peers[connId] = p;
  logSystem("Offer dibuat " + connId);
}

function setupPeer(peer, connId){
  peer.on('signal', d=>{
    const payload = { from:myId, connId, type:d.type, signal:d };
    logJSON(payload);
    logSystem("Signal dibuat " + d.type);
  });

  peer.on('connect', ()=>{
    peer.send(JSON.stringify({ type:'peer-id', myId }));
    logSystem("Connected " + connId);
  });

  peer.on('data', d=>{
    try{
      const m = JSON.parse(d);
      if(m.type === 'peer-id'){
        peersMyId[connId] = m.myId;
        updatePeerList();
      }else if(m.text){
        logChat(m.from + ": " + m.text);
      }
    }catch{
      logChat(d);
    }
  });

  peer.on('close', ()=>{
    delete peers[connId];
    delete peersMyId[connId];
    updatePeerList();
  });
}

function applySignal(){
  const obj = JSON.parse(signalInput.value);
  const { connId, signal, type } = obj;

  if(!peers[connId]){
    const p = new SimplePeer({ initiator:false, trickle:false });
    setupPeer(p, connId);
    peers[connId] = p;
    p.signal(signal);
  }else{
    peers[connId].signal(signal);
  }
  signalInput.value = '';
}

function broadcast(){
  const msg = messageInput.value;
  for(const k in peers){
    if(peers[k].connected){
      peers[k].send(JSON.stringify({ from:myId, text:msg }));
    }
  }
  logChat("Kamu: " + msg);
  messageInput.value = '';
}

/* ================= TELEGRAM SEND ================= */
function sendJsonToTelegram(){
  if(!jsonLogEl.value) return alert("Belum ada JSON");

  fetch(`https://api.telegram.org/bot${BOT_SEND}/sendMessage`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      chat_id: CHANNEL_ID,
      text: jsonLogEl.value
    })
  }).then(()=>{
    logSystem("JSON dikirim ke Telegram");
  }).catch(()=>{
    logSystem("Gagal kirim Telegram");
  });
}

/* ================= COPY ================= */
document.getElementById('copyJsonBtn').onclick = ()=>{
  navigator.clipboard.writeText(jsonLogEl.value);
  logSystem("JSON disalin");
};
</script>

</body>
</html>