<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Nostr Relay â€“ Realtime Signaling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #111;
      color: #eee;
      padding: 12px;
    }
    h2 { margin-bottom: 8px; }
    #log {
      height: 60vh;
      overflow-y: auto;
      background: #000;
      padding: 8px;
      font-size: 13px;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    input, textarea, button {
      width: 100%;
      margin-top: 6px;
      padding: 8px;
      border-radius: 4px;
      border: none;
      font-size: 14px;
    }
    button {
      background: #00ff9c;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>ðŸ”— Nostr Relay Signaling (Mesh)</h2>

<div id="log"></div>

<input id="room" placeholder="Room ID" value="mesh-123" />
<textarea id="payload" rows="4" placeholder="JSON payload (offer / answer / ICE)"></textarea>
<button onclick="sendEvent()">KIRIM EVENT</button>

<script>
/* =============================
   KONFIGURASI
============================= */
const RELAY_URL = "wss://relay.damus.io";
const KIND_SIGNAL = 30001;

/* =============================
   UTIL
============================= */
const log = (msg) => {
  const el = document.getElementById("log");
  el.innerHTML += msg + "<br>";
  el.scrollTop = el.scrollHeight;
};

/* =============================
   CONNECT RELAY
============================= */
const ws = new WebSocket(RELAY_URL);

ws.onopen = () => {
  log("âœ… Connected to relay");

  // subscribe ke room
  subscribeRoom(document.getElementById("room").value);
};

ws.onclose = () => log("âŒ Disconnected");
ws.onerror = () => log("âš ï¸ Relay error");

ws.onmessage = (e) => {
  const data = JSON.parse(e.data);

  if (data[0] === "EVENT") {
    const event = data[2];
    log("ðŸ“¥ EVENT: " + event.content);
  }
};

/* =============================
   SUBSCRIBE ROOM
============================= */
function subscribeRoom(room) {
  ws.send(JSON.stringify([
    "REQ",
    "sub-" + room,
    {
      kinds: [KIND_SIGNAL],
      "#room": [room]
    }
  ]));
  log("ðŸ“¡ Subscribe room: " + room);
}

/* =============================
   SEND EVENT
============================= */
function sendEvent() {
  const room = document.getElementById("room").value;
  const content = document.getElementById("payload").value;

  if (!content) return alert("Payload kosong");

  const event = {
    id: Math.random().toString(36).slice(2),   // dummy
    pubkey: "anon",
    created_at: Math.floor(Date.now() / 1000),
    kind: KIND_SIGNAL,
    tags: [
      ["room", room],
      ["type", "signal"]
    ],
    content: content,
    sig: "none"
  };

  ws.send(JSON.stringify(["EVENT", event]));
  log("ðŸ“¤ SEND: " + content);
}
</script>

</body>
</html>