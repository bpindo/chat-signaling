<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>P2P Mesh via Mini Railway</title>

<style>
body{
  font-family: system-ui, monospace;
  background:#f4f7fb;
  padding:20px;
  max-width:600px;
  margin:auto;
}
button,input{
  width:100%;
  padding:12px;
  margin-top:10px;
  font-family:monospace;
}
pre{
  background:#0f172a;
  color:#e5e7eb;
  padding:12px;
  height:200px;
  overflow:auto;
  border-radius:6px;
}
</style>
</head>

<body>

<h3>ðŸš„ P2P Mesh (Mini Railway)</h3>

<button onclick="makeOffer()">âž• Buat Offer</button>

<input id="msg" placeholder="Ketik pesan">
<button onclick="sendMsg()">Kirim</button>

<pre id="log"></pre>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script>
/* ================= CONFIG ================= */
const WS_URL = "ws://192.168.1.10:8080";

/* ================= STATE ================= */
const myId = "u-" + Math.random().toString(36).slice(2,7);
const peers = {};
const logEl = document.getElementById("log");

function log(m){
  logEl.textContent += m + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

log("ðŸ†” ID: " + myId);

/* ================= WEBSOCKET ================= */
const ws = new WebSocket(WS_URL);

ws.onopen = () => log("ðŸŸ¢ WebSocket connected");
ws.onerror = () => log("âŒ WebSocket error");
ws.onclose = () => log("ðŸ”´ WebSocket closed");

ws.onmessage = e => {
  try{
    const msg = JSON.parse(e.data);
    if(msg.from === myId) return;

    if(msg.type === "offer"){
      answerOffer(msg);
    }

    if(msg.type === "answer"){
      const p = peers[msg.connId];
      if(p) p.signal(msg.signal);
    }
  }catch{}
};

/* ================= P2P ================= */
function makeOffer(){
  const connId = crypto.randomUUID();
  const p = new SimplePeer({initiator:true,trickle:false});
  peers[connId] = p;

  p.on("signal", s=>{
    ws.send(JSON.stringify({
      type:"offer",
      from:myId,
      connId,
      signal:s
    }));
  });

  p.on("connect", ()=>log("âœ… CONNECTED " + connId));
  p.on("data", d=>log("ðŸ’¬ " + d));
}

function answerOffer(o){
  if(peers[o.connId]) return;

  const p = new SimplePeer({initiator:false,trickle:false});
  peers[o.connId] = p;

  p.on("signal", s=>{
    ws.send(JSON.stringify({
      type:"answer",
      from:myId,
      connId:o.connId,
      signal:s
    }));
  });

  p.on("connect", ()=>log("âœ… CONNECTED " + o.connId));
  p.on("data", d=>log("ðŸ’¬ " + d));

  p.signal(o.signal);
}

/* ================= CHAT ================= */
function sendMsg(){
  const v = msg.value;
  for(const k in peers){
    if(peers[k].connected){
      peers[k].send(v);
    }
  }
  log("me: " + v);
  msg.value="";
}
</script>

</body>
</html>