<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Adaptive Mesh Signaling via Telegram</title>

<style>
body{font-family:monospace;background:#f4f7fb;padding:20px}
button,textarea,input{width:100%;margin-top:8px;padding:10px}
pre{background:#0f172a;color:#e5e7eb;padding:10px;height:200px;overflow:auto}
</style>
</head>

<body>

<h3>üåê Adaptive Mesh Signaling</h3>

<button onclick="createOffer()">‚ûï Buat Offer (Auto Kirim)</button>

<textarea id="jsonLog" rows="6" readonly></textarea>

<input id="messageInput" placeholder="Pesan">
<button onclick="broadcast()">Kirim Pesan</button>

<pre id="systemLog"></pre>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script>
/* ================= BOT INFO ================= */
const BOT_SEND = "8384730708:AAHjPCLYpW7wz2B5-jBxMJ17-kH1G1zXZuY";
const BOT_READ = "359218339:AAF7KH-T3ihEPvHfWPJge_Ax9PdV9GQw2W0";
const CHANNEL_ID = "-1003689025820";

/* ================= STATE ================= */
const myId = "peer-" + Math.random().toString(36).slice(2,8);
const peers = {};
let lastUpdateId = 0;

const seenEvents = new Map();           // eventHash -> timestamp
const seenConnSignal = new Set();       // connId + type

const EVENT_TTL = 60000; // 60 detik

let pollInterval = 5000;
let pollTimer = null;

const logEl = document.getElementById("systemLog");
const jsonLogEl = document.getElementById("jsonLog");
const messageInput = document.getElementById("messageInput");

/* ================= UTIL ================= */
function log(m){
  logEl.textContent += m + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

function hashEvent(str){
  let h=0;
  for(let i=0;i<str.length;i++){
    h=(h<<5)-h+str.charCodeAt(i);
    h|=0;
  }
  return h.toString();
}

function getEventId(o){
  return hashEvent(
    o.from +
    o.connId +
    o.type +
    JSON.stringify(o.signal)
  );
}

/* ================= TELEGRAM SEND ================= */
function sendToTelegram(obj){
  fetch(`https://api.telegram.org/bot${BOT_SEND}/sendMessage`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      chat_id: CHANNEL_ID,
      text: JSON.stringify(obj)
    })
  }).then(()=>log("üì§ Sent to Telegram"));
}

/* ================= PEER ================= */
function createOffer(){
  const connId = "conn-" + crypto.randomUUID();
  const p = new SimplePeer({initiator:true,trickle:false});
  peers[connId] = p;
  setupPeer(p,connId);
  log("Offer dibuat " + connId);
}

function setupPeer(p,connId){
  p.on("signal", d=>{
    const payload = {
      from: myId,
      connId,
      type: d.type,
      signal: d,
      ts: Date.now()
    };
    jsonLogEl.value = JSON.stringify(payload,null,2);
    sendToTelegram(payload);
  });

  p.on("connect", ()=>{
    log("‚úÖ CONNECTED " + connId);
  });

  p.on("data", d=>{
    log("üí¨ " + d);
  });
}

/* ================= APPLY SIGNAL ================= */
function applySignal(obj){
  if(obj.from === myId) return;

  const key = obj.connId + "-" + obj.type;
  if(seenConnSignal.has(key)) return;

  if(!peers[obj.connId]){
    const p = new SimplePeer({initiator:false,trickle:false});
    peers[obj.connId] = p;
    setupPeer(p,obj.connId);
    p.signal(obj.signal);
    log("‚¨áÔ∏è OFFER diterima " + obj.connId);
  }else{
    peers[obj.connId].signal(obj.signal);
    log("‚¨áÔ∏è ANSWER diterapkan " + obj.connId);
  }

  seenConnSignal.add(key);
}

/* ================= TELEGRAM POLL ================= */
async function pollTelegram(){
  try{
    const r = await fetch(
      `https://api.telegram.org/bot${BOT_READ}/getUpdates?offset=${lastUpdateId+1}`
    );
    const j = await r.json();
    if(!j.result) return;

    let applied = 0;

    j.result.forEach(u=>{
      lastUpdateId = u.update_id;
      const m = u.channel_post || u.message;
      if(!m?.text) return;

      let obj;
      try{ obj = JSON.parse(m.text); }catch{ return; }

      if(!obj.connId || !obj.signal) return;

      /* ===== DEDUP ===== */
      const eid = getEventId(obj);
      if(seenEvents.has(eid)) return;

      /* ===== TTL ===== */
      if(Date.now() - (obj.ts||0) > EVENT_TTL) return;

      seenEvents.set(eid, Date.now());
      applySignal(obj);
      applied++;
    });

    adaptivePoll(applied);

  }catch(e){
    log("‚ùå Telegram error");
  }
}

/* ================= ADAPTIVE POLLING ================= */
function adaptivePoll(applied){
  const nodeCount = Object.keys(peers).length || 1;
  pollInterval = Math.min(30000, 4000 + nodeCount * 2000);
  restartPoll();
}

function restartPoll(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(pollTelegram, pollInterval);
}

/* ================= CHAT ================= */
function broadcast(){
  const msg = messageInput.value;
  for(const k in peers){
    if(peers[k].connected){
      peers[k].send(msg);
    }
  }
  log("Kamu: " + msg);
  messageInput.value="";
}

/* ================= GC ================= */
setInterval(()=>{
  const now = Date.now();
  for(const [k,t] of seenEvents){
    if(now - t > EVENT_TTL){
      seenEvents.delete(k);
    }
  }
},15000);

/* ================= START ================= */
log("MY ID = " + myId);
restartPoll();
</script>

</body>
</html>