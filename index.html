<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Multi-Peer Mesh Manual Signaling</title>

<style>
body { font-family: monospace; background:#111; color:#0f0; padding:15px }
textarea, input, button {
  width:100%; background:#000; color:#0f0;
  border:1px solid #0f0; margin:8px 0; padding:8px;
  box-sizing:border-box; font-family:monospace;
}
button { cursor:pointer }
pre { background:#000; padding:10px; height:220px; overflow:auto; white-space:pre-wrap }
.peer-section { border:1px solid #0f0; padding:10px; margin-bottom:12px }
</style>
</head>

<body>

<h2>üåê Multi-Peer Mesh Manual Signaling</h2>
<div><strong>ID:</strong> <span id="myId"></span></div>

<div class="peer-section">
  <strong>1Ô∏è‚É£ Buat Offer Baru</strong><br>
  <button onclick="createOffer()">Buat Offer</button>
</div>

<div class="peer-section">
  <strong>2Ô∏è‚É£ Signaling</strong><br>
  <textarea id="signalInput" rows="7" placeholder="Paste signaling di sini"></textarea>
  <button onclick="applySignal()">Apply Signaling</button>
</div>

<div class="peer-section">
  <strong>3Ô∏è‚É£ Kirim Pesan</strong><br>
  <input id="messageInput" placeholder="Pesan">
  <button onclick="broadcast()">Kirim</button>
</div>

<div>
  <strong>üì° Log</strong>
  <pre id="log"></pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script>
const myId = 'anom' + Math.floor(1000 + Math.random()*9000);
document.getElementById('myId').textContent = myId;

const peers = {}; // connId -> peer
const logEl = document.getElementById('log');

function log(msg){
  logEl.textContent += msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

/* ======================
   CREATE OFFER
====================== */
function createOffer(){
  const connId = 'conn-' + crypto.randomUUID();

  const peer = new SimplePeer({ initiator:true, trickle:false });
  setupPeer(peer, connId);

  peers[connId] = peer;
  log(`‚è≥ Offer dibuat (${connId})`);
}

/* ======================
   SETUP PEER
====================== */
function setupPeer(peer, connId){
  peer.on('signal', data=>{
    const payload = {
      from: myId,
      connId,
      type: data.type,
      signal: data
    };
    log(`### ${data.type.toUpperCase()} (${connId})\n` +
        JSON.stringify(payload,null,2));
  });

  peer.on('connect', ()=>{
    log(`‚úÖ Connected (${connId})`);
  });

  peer.on('data', d=>{
    const m = JSON.parse(d);
    log(`üë§ ${m.from}: ${m.text}`);
  });

  peer.on('close', ()=>{
    log(`‚ö†Ô∏è Closed (${connId})`);
    delete peers[connId];
  });

  peer.on('error', e=>{
    log(`‚ùå ${connId}: ${e.message}`);
  });
}

/* ======================
   APPLY SIGNAL
====================== */
function applySignal(){
  let obj;
  try { obj = JSON.parse(signalInput.value.trim()); }
  catch { return alert('JSON tidak valid'); }

  const { connId, signal, type } = obj;
  if (!connId || !signal || !type)
    return alert('Format signaling salah');

  /* RECEIVER */
  if (!peers[connId]) {
    if (type !== 'offer')
      return alert('Receiver hanya menerima OFFER');

    const peer = new SimplePeer({ initiator:false, trickle:false });
    setupPeer(peer, connId);
    peers[connId] = peer;

    peer.signal(signal);
    log(`‚è≥ OFFER diterima (${connId})`);
  }
  /* INITIATOR */
  else {
    peers[connId].signal(signal);
    log(`‚úÖ ${type.toUpperCase()} diterapkan (${connId})`);
  }

  signalInput.value='';
}

/* ======================
   BROADCAST
====================== */
function broadcast(){
  const msg = messageInput.value.trim();
  if (!msg) return;

  for (const id in peers){
    if (peers[id].connected){
      peers[id].send(JSON.stringify({ from: myId, text: msg }));
    }
  }
  log(`üó®Ô∏è Kamu: ${msg}`);
  messageInput.value='';
}
</script>

</body>
</html>
