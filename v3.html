<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mesh Signaling â†’ Hive</title>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@hiveio/hive-js/dist/hive.min.js"></script>

<style>
:root{
  --bg:#f4f7fb;--card:#fff;--border:#d0d7e2;
  --primary:#2563eb;--text:#1f2937;
}
body{
  font-family:system-ui,monospace;
  background:var(--bg);color:var(--text);
  padding:16px;max-width:760px;margin:auto
}
textarea,input,button{
  width:100%;padding:10px;margin:8px 0;
  border-radius:6px;border:1px solid var(--border);
  font-family:monospace;box-sizing:border-box
}
button{background:var(--primary);color:#fff;border:none;font-weight:600;cursor:pointer}
button:hover{opacity:.9}
.peer-section{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:8px;
  padding:12px;margin-bottom:12px
}
pre{
  background:#f9fafb;border:1px solid var(--border);
  border-radius:8px;padding:12px;height:160px;
  overflow:auto;font-size:13px
}
#jsonLog{
  background:#0f172a;color:#e5e7eb;
  border-radius:8px;font-size:13px
}
</style>
</head>

<body>

<h2><center>Multi-Peer Mesh Manual Signaling</center></h2>

<div class="peer-section">
  <button onclick="createOffer()">Buat Offer</button>
</div>

<div class="peer-section">
  <textarea id="signalInput" rows="3"
    placeholder="Paste signaling JSON di sini"></textarea>
  <button onclick="applySignal()">Apply Signaling</button>
</div>

<div class="peer-section">
  <input id="messageInput" placeholder="Pesan">
  <button onclick="broadcast()">Kirim Pesan</button>
</div>

<div class="peer-section">
  <pre id="log"></pre>
</div>

<div class="peer-section">
  <strong>Signaling JSON</strong>
  <textarea id="jsonLog" rows="8" readonly
    placeholder="Offer / Answer akan muncul di sini"></textarea>

  <!-- ðŸ”¥ TOMBOL BARU -->
  <button onclick="sendToHive()">Kirim ke Blockchain</button>
</div>

<!-- ðŸ”½ BAGIAN BARU -->
<div class="peer-section">
  <b>Isi Komentar Hive (Live)</b>
  <textarea id="hiveContent" rows="8" readonly
    placeholder="Klik ambil data terbaru..."></textarea>
  <button onclick="loadHiveComment()">Ambil Data Terbaru</button>
</div>

<script>
/* ======================
   HIVE CONFIG (STATIS)
====================== */
const HIVE={
  user:"bagasadi",
  key:"5K1NkJgJ2KrRcoJkBYFVE6v6icQgDh9dup8JkaTPPuQBfjY4oKS",
  parentAuthor:"rewar.app",
  parentPermlink:"are-you-ready",
  commentPermlink:"comment-1768732863127"
};

hive.api.setOptions({url:"https://api.hive.blog"});
hive.api.getConfig((e,r)=>!e&&hive.config.set("chain_id",r.HIVE_CHAIN_ID));

/* ======================
   PEER SETUP
====================== */
const myId='anom'+Math.floor(1000+Math.random()*9000);
const peers={},logEl=log,jsonLogEl=jsonLog;

function logText(t){
  logEl.textContent+=t+"\n";
  logEl.scrollTop=logEl.scrollHeight;
}
function logJSON(o){
  jsonLogEl.value=JSON.stringify(o,null,2);
  jsonLogEl.scrollTop=0;
}

/* ======================
   OFFER
====================== */
function createOffer(){
  const id='conn-'+crypto.randomUUID();
  const p=new SimplePeer({initiator:true,trickle:false});
  peers[id]=p;setupPeer(p,id);
  logText(`â³ Offer dibuat (${id})`);
}

function setupPeer(p,id){
  p.on('signal',d=>{
    const o={from:myId,connId:id,type:d.type,signal:d};
    logText(`ðŸ“¡ ${d.type.toUpperCase()} (${id})`);
    logJSON(o);
  });
  p.on('connect',()=>logText(`âœ… Connected (${id})`));
  p.on('data',d=>{
    const m=JSON.parse(d);
    logText(`ðŸ’¬ ${m.from}: ${m.text}`);
  });
  p.on('close',()=>{logText(`âš ï¸ Closed (${id})`);delete peers[id]});
  p.on('error',e=>logText(`âŒ ${id}: ${e.message}`));
}

/* ======================
   APPLY SIGNAL
====================== */
function applySignal(){
  let o;
  try{o=JSON.parse(signalInput.value)}catch{
    return alert("JSON tidak valid");
  }
  const {connId,signal,type}=o;
  if(!peers[connId]){
    if(type!=="offer")return alert("Harus OFFER");
    const p=new SimplePeer({initiator:false,trickle:false});
    peers[connId]=p;setupPeer(p,connId);
    p.signal(signal);
  }else{
    peers[connId].signal(signal);
  }
  logJSON(o);
  signalInput.value="";
}

/* ======================
   CHAT
====================== */
function broadcast(){
  const m=messageInput.value.trim();
  if(!m)return;
  for(const id in peers){
    peers[id].connected&&peers[id].send(JSON.stringify({from:myId,text:m}));
  }
  logText(`ðŸ—¨ï¸ Kamu: ${m}`);
  messageInput.value="";
}

/* ======================
   ðŸ”¥ SEND JSON TO HIVE
====================== */
function sendToHive(){
  const body=jsonLogEl.value.trim();
  if(!body)return alert("Signaling JSON kosong");

  hive.broadcast.comment(
    HIVE.key,
    HIVE.parentAuthor,
    HIVE.parentPermlink,
    HIVE.user,
    HIVE.commentPermlink,   // â† EDIT KOMENTAR
    "",
    body,
    JSON.stringify({app:"mesh-signaling",tags:["comment"]}),
    e=>e?alert(e.message):alert("Komentar Hive diperbarui")
  );
}

/* ========= LOAD COMMENT ========= */
function loadHiveComment(){
  hive.api.getContent(
    HIVE.user,
    HIVE.commentPermlink,
    (e,r)=>{
      if(e||!r.body)return alert("Gagal ambil komentar");
      hiveContent.value=r.body;
    }
  );
}
</script>

</body>
</html>
