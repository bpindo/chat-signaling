<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Stable Stateless Mesh via Telegram</title>

<style>
body{
  font-family:system-ui,monospace;
  background:#f4f7fb;
  padding:20px;
  max-width:600px;
  margin:auto
}
h3{margin-bottom:10px}
input,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  font-family:monospace
}
pre{
  background:#0f172a;
  color:#e5e7eb;
  padding:10px;
  height:220px;
  overflow:auto;
  border-radius:8px
}
small{color:#555}
</style>
</head>

<body>

<h3>ğŸŒ Stable Stateless P2P Mesh</h3>
<small>Auto connect Â· No coordination Â· Telegram bootstrap only</small>

<input id="msg" placeholder="Pesan">
<button onclick="sendMsg()">Kirim</button>

<pre id="log"></pre>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script>
/* ===== CONFIG ===== */
const BOT_SEND = "8384730708:AAHjPCLYpW7wz2B5-jBxMJ17-kH1G1zXZuY";
const BOT_READ = "359218339:AAF7KH-T3ihEPvHfWPJge_Ax9PdV9GQw2W0";
const CHANNEL = "-1003689025820";

const POLL_INTERVAL = 5000;
const MAX_PEERS = 5;

/* ===== STATE LOKAL ===== */
const id = "p-" + Math.random().toString(36).slice(2,7);
const peers = {};
let lastUpdate = 0;
let helloSent = false;

const logEl = document.getElementById("log");
const log = m => {
  logEl.textContent += m + "\n";
  logEl.scrollTop = logEl.scrollHeight;
};

log("ID: " + id);

/* ===== UTIL ===== */
const peerCount = () =>
  Object.values(peers).filter(p=>p.connected).length;

/* ===== TELEGRAM SEND ===== */
function sendTG(obj){
  fetch(`https://api.telegram.org/bot${BOT_SEND}/sendMessage`,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      chat_id: CHANNEL,
      text: JSON.stringify(obj)
    })
  });
}

/* ===== HELLO (ONE SHOT) ===== */
function maybeHello(){
  if(helloSent) return;
  if(peerCount() >= MAX_PEERS) return;

  helloSent = true;
  sendTG({ t:"hello", from:id });
  log("ğŸ‘‹ hello sent");
}

/* ===== PEER ===== */
function createOffer(target){
  if(peerCount() >= MAX_PEERS) return;

  const cid = crypto.randomUUID();
  const p = new SimplePeer({initiator:true,trickle:false});
  peers[cid] = p;

  p.on("signal", s=>{
    sendTG({
      t:"offer",
      from:id,
      to:target,
      connId:cid,
      signal:s
    });
  });

  attachPeer(p,cid);
}

function answerOffer(o){
  if(peerCount() >= MAX_PEERS) return;

  const p = new SimplePeer({initiator:false,trickle:false});
  peers[o.connId] = p;

  p.on("signal", s=>{
    sendTG({
      t:"answer",
      from:id,
      to:o.from,
      connId:o.connId,
      signal:s
    });
  });

  attachPeer(p,o.connId);
  p.signal(o.signal);
}

function attachPeer(p,cid){
  p.on("connect", ()=>{
    log("âœ… connected " + cid);
  });

  p.on("data", d=>{
    log("ğŸ’¬ " + d);
  });

  p.on("close", ()=>{
    delete peers[cid];
    helloSent = false;
    maybeHello();
  });

  p.on("error", ()=>{
    delete peers[cid];
    helloSent = false;
    maybeHello();
  });
}

/* ===== POLLING ===== */
async function poll(){
  try{
    const r = await fetch(
      `https://api.telegram.org/bot${BOT_READ}/getUpdates?offset=${lastUpdate+1}`
    );
    const j = await r.json();
    if(!j.result) return;

    j.result.forEach(u=>{
      lastUpdate = u.update_id;
      const m = u.channel_post || u.message;
      if(!m?.text) return;

      try{
        const o = JSON.parse(m.text);
        if(o.from === id) return;

        if(o.t === "hello"){
          if(peerCount() < MAX_PEERS){
            createOffer(o.from);
          }
        }

        if(o.t === "offer" && o.to === id){
          if(!peers[o.connId]){
            answerOffer(o);
          }
        }

        if(o.t === "answer" && o.to === id){
          const p = peers[o.connId];
          if(p) p.signal(o.signal);
        }
      }catch{}
    });
  }catch{}
}

/* ===== CHAT ===== */
function sendMsg(){
  const v = msg.value;
  for(const k in peers){
    if(peers[k].connected){
      peers[k].send(v);
    }
  }
  log("me: " + v);
  msg.value="";
}

/* ===== START ===== */
setTimeout(maybeHello, Math.random()*1500);
setInterval(poll, POLL_INTERVAL);
</script>

</body>
</html>