<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mesh Signaling Hive (Adaptive)</title>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@hiveio/hive-js/dist/hive.min.js"></script>

<style>
body{font-family:system-ui;background:#f4f7fb;padding:12px}
pre,textarea{width:100%;min-height:120px;font-family:monospace}
button{padding:8px;margin:4px}
</style>
</head>
<body>

<h3>Mesh Signaling Hive (Adaptive Polling)</h3>
<button onclick="createOffer()">Buat Offer</button>
<input id="msg" placeholder="pesan"/>
<button onclick="broadcast()">Kirim</button>

<pre id="log"></pre>

<script>
/* ================= HIVE ================= */
const HIVE = {
  user: "bagasadi",
  key: "ISI_KEY_SENDIRI",
  parentAuthor: "rewar.app",
  parentPermlink: "are-you-ready",
  commentPermlink: "comment-1768732863127"
};

hive.api.setOptions({ url:"https://api.hive.blog" });
hive.api.getConfig((e,r)=>!e&&hive.config.set("chain_id",r.HIVE_CHAIN_ID));

hive.api.getContentAsync=(a,p)=>new Promise((res,rej)=>{
  hive.api.getContent(a,p,(e,r)=>e?rej(e):res(r))
});

/* ================= STATE ================= */
const myId = "node-"+Math.random().toString(36).slice(2,7);
const peers = {};
const directPeers = new Set();
const knownPeers = new Set([myId]);
const meshLinks = new Map();
const seenEvents = new Set();

let pollTimer = null;

/* ================= LOG ================= */
const logEl=document.getElementById("log");
const log=t=>{logEl.textContent+=t+"\n";logEl.scrollTop=99999};

/* ================= MESH EVENT ================= */
function meshEvent(evt,peer){
  const ev={
    type:"mesh-event",
    evt,
    id:`evt-${myId}-${Date.now()}`,
    from:myId,
    peer,
    ts:Date.now(),
    hops:0,
    ttl:3
  };
  seenEvents.add(ev.id);
  broadcastRaw(ev);
}

function handleMeshEvent(ev){
  if(seenEvents.has(ev.id)) return;
  if(ev.hops>=ev.ttl) return;

  seenEvents.add(ev.id);
  knownPeers.add(ev.from);
  if(ev.peer) knownPeers.add(ev.peer);

  if(ev.evt==="mesh:connect"){
    meshLinks.set(`${ev.from}-${ev.peer}`,Date.now());
  }

  ev.hops++;
  broadcastRaw(ev);
}

/* ================= POLLING ================= */
function computeHiveInterval(){
  const n = directPeers.size;
  if(n<=1) return 5000;
  if(n===2) return 30000;
  if(n===3) return 60000;
  return 120000;
}

function restartPolling(){
  if(pollTimer) clearTimeout(pollTimer);
  const interval = computeHiveInterval();
  log(`â±ï¸ Poll Hive tiap ${interval/1000}s`);
  pollTimer=setTimeout(async ()=>{
    await checkHive();
    restartPolling();
  },interval);
}

/* ================= PEER ================= */
function setupPeer(p,id){
  p.on("connect",()=>{
    directPeers.add(id);
    log(`âœ… CONNECT ${id}`);
    meshEvent("mesh:connect",id);
    restartPolling();
  });

  p.on("close",()=>{
    directPeers.delete(id);
    delete peers[id];
    log(`âŒ CLOSE ${id}`);
    restartPolling();
  });

  p.on("data",d=>{
    const m=JSON.parse(d);
    if(m.type==="mesh-event") handleMeshEvent(m);
    else log(`ðŸ’¬ ${m.from}: ${m.text}`);
  });
}

/* ================= OFFER ================= */
function createOffer(){
  const id="conn-"+crypto.randomUUID();
  const p=new SimplePeer({initiator:true,trickle:false});
  peers[id]=p;
  setupPeer(p,id);

  p.on("signal",sig=>{
    sendSignal({from:myId,connId:id,type:sig.type,signal:sig});
  });
}

/* ================= SIGNALING ================= */
async function sendSignal(sig){
  const c=await hive.api.getContentAsync(HIVE.user,HIVE.commentPermlink);
  let arr=[];
  try{arr=JSON.parse(c.body)||[]}catch{}
  arr.push(sig);

  hive.broadcast.comment(
    HIVE.key,
    HIVE.parentAuthor,
    HIVE.parentPermlink,
    HIVE.user,
    HIVE.commentPermlink,
    "",
    JSON.stringify(arr),
    "{}",
    ()=>log("ðŸ“¡ Signal ke Hive")
  );
}

async function checkHive(){
  log("ðŸ” cek Hive");
  const c=await hive.api.getContentAsync(HIVE.user,HIVE.commentPermlink);
  let arr=[];
  try{arr=JSON.parse(c.body)||[]}catch{}
  arr.forEach(s=>{
    if(s.from===myId) return;
    if(!peers[s.connId]&&s.type==="offer"){
      const p=new SimplePeer({initiator:false,trickle:false});
      peers[s.connId]=p;
      setupPeer(p,s.connId);
      p.signal(s.signal);
    }else if(peers[s.connId]){
      peers[s.connId].signal(s.signal);
    }
  });
}

/* ================= CHAT ================= */
function broadcast(){
  const t=document.getElementById("msg").value;
  Object.values(peers).forEach(p=>{
    if(p.connected)p.send(JSON.stringify({from:myId,text:t}));
  });
  log(`ðŸ—¨ï¸ kamu: ${t}`);
}

/* ================= RAW SEND ================= */
function broadcastRaw(obj){
  Object.values(peers).forEach(p=>{
    if(p.connected)p.send(JSON.stringify(obj));
  });
}

/* ================= START ================= */
log("ðŸŸ¢ node "+myId+" start");
restartPolling();
</script>

</body>
</html>