<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Stateless P2P Mesh (Auto Join)</title>

<style>
body{font-family:monospace;background:#f4f7fb;padding:20px}
input,button{width:100%;margin-top:8px;padding:10px}
pre{background:#0f172a;color:#e5e7eb;padding:10px;height:220px;overflow:auto}
</style>
</head>

<body>

<h3>üåê Stateless P2P Mesh</h3>

<input id="msg" placeholder="Pesan">
<button onclick="sendMsg()">Kirim</button>

<pre id="log"></pre>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script>
/* ===== CONFIG ===== */
const BOT_SEND = "8384730708:AAHjPCLYpW7wz2B5-jBxMJ17-kH1G1zXZuY";
const BOT_READ = "359218339:AAF7KH-T3ihEPvHfWPJge_Ax9PdV9GQw2W0";
const CHANNEL  = "-1003689025820";

const POLL_INTERVAL = 5000;
const MAX_PEERS = 5;

/* ===== STATE LOKAL ===== */
const id = "p-" + Math.random().toString(36).slice(2,7);
const peers = {};          // connId -> SimplePeer
let lastUpdate = 0;

const logEl = document.getElementById("log");
const log = m => {
  logEl.textContent += m + "\n";
  logEl.scrollTop = logEl.scrollHeight;
};

log("ID: " + id);

/* ===== UTIL ===== */
function peerCount(){
  return Object.values(peers).filter(p => p.connected).length;
}

/* ===== TELEGRAM SEND ===== */
function sendTG(obj){
  fetch(`https://api.telegram.org/bot${BOT_SEND}/sendMessage`,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      chat_id: CHANNEL,
      text: JSON.stringify(obj)
    })
  });
}

/* ===== HELLO ===== */
function sendHello(){
  if(peerCount() >= MAX_PEERS) return;
  sendTG({ t:"hello", from:id });
  log("üëã hello sent");
}

/* ===== PEER ===== */
function makeOffer(){
  if(peerCount() >= MAX_PEERS) return;

  const cid = crypto.randomUUID();
  const p = new SimplePeer({initiator:true,trickle:false});
  peers[cid] = p;

  p.on("signal", s=>{
    sendTG({ t:"offer", from:id, connId:cid, signal:s });
  });

  p.on("connect", ()=>{
    log("‚úÖ connected " + cid);
  });

  p.on("data", d=>{
    log("üí¨ " + d);
  });
}

function answerOffer(o){
  if(peerCount() >= MAX_PEERS) return;

  const p = new SimplePeer({initiator:false,trickle:false});
  peers[o.connId] = p;

  p.on("signal", s=>{
    sendTG({ t:"answer", from:id, connId:o.connId, signal:s });
  });

  p.on("connect", ()=>{
    log("‚úÖ connected " + o.connId);
  });

  p.on("data", d=>{
    log("üí¨ " + d);
  });

  p.signal(o.signal);
}

/* ===== POLLING ===== */
async function poll(){
  const r = await fetch(
    `https://api.telegram.org/bot${BOT_READ}/getUpdates?offset=${lastUpdate+1}`
  );
  const j = await r.json();
  if(!j.result) return;

  j.result.forEach(u=>{
    lastUpdate = u.update_id;
    const m = u.channel_post || u.message;
    if(!m?.text) return;

    try{
      const o = JSON.parse(m.text);
      if(o.from === id) return;

      /* HELLO = pancing OFFER */
      if(o.t === "hello"){
        if(peerCount() < MAX_PEERS){
          makeOffer();
        }
      }

      /* OFFER */
      if(o.t === "offer"){
        if(!peers[o.connId] && peerCount() < MAX_PEERS){
          answerOffer(o);
        }
      }

      /* ANSWER */
      if(o.t === "answer"){
        const p = peers[o.connId];
        if(p) p.signal(o.signal);
      }
    }catch{}
  });
}

/* ===== CHAT ===== */
function sendMsg(){
  const v = msg.value;
  for(const k in peers){
    if(peers[k].connected){
      peers[k].send(v);
    }
  }
  log("me: " + v);
  msg.value="";
}

/* ===== START ===== */
sendHello();                       // user baru langsung announce
setInterval(sendHello, 20000);     // user lama sesekali buka pintu
setInterval(poll, POLL_INTERVAL);  // polling bodoh tapi stabil
</script>

</body>
</html>