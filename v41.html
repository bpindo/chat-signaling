<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Stateless Mesh + Beacon Node</title>

<style>
body{font-family:monospace;background:#f4f7fb;padding:20px}
button,input{width:100%;margin-top:8px;padding:10px}
pre{background:#0f172a;color:#e5e7eb;padding:10px;height:220px;overflow:auto}
.toggle{background:#16a34a}
.toggle.off{background:#9ca3af}
</style>
</head>

<body>

<h3>ğŸŒ Stateless P2P Mesh</h3>

<button onclick="makeOffer()">â• Buat Offer</button>

<button id="beaconBtn" class="toggle off" onclick="toggleBeacon()">
ğŸ“¡ Pusat Node: OFF
</button>

<input id="msg" placeholder="Pesan">
<button onclick="sendMsg()">Kirim</button>

<pre id="log"></pre>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script>
/* ===== CONFIG ===== */
const BOT_SEND = "8384730708:AAHjPCLYpW7wz2B5-jBxMJ17-kH1G1zXZuY";
const BOT_READ = "359218339:AAF7KH-T3ihEPvHfWPJge_Ax9PdV9GQw2W0";
const CHANNEL = "-1003689025820";
const POLL_INTERVAL = 5000;
const HELLO_INTERVAL = 12000;

/* ===== STATE ===== */
const id = "p-" + Math.random().toString(36).slice(2,7);
const peers = {};
let lastUpdate = 0;
let beaconOn = false;
let helloTimer = null;

const logEl = document.getElementById("log");
const log = m => {
  logEl.textContent += m + "\n";
  logEl.scrollTop = logEl.scrollHeight;
};

log("ID: " + id);

/* ===== TELEGRAM SEND ===== */
function sendTG(obj){
  fetch(`https://api.telegram.org/bot${BOT_SEND}/sendMessage`,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      chat_id: CHANNEL,
      text: JSON.stringify(obj)
    })
  });
}

/* ===== PEER ===== */
function makeOffer(){
  const cid = crypto.randomUUID();
  const p = new SimplePeer({initiator:true,trickle:false});
  peers[cid] = p;

  p.on("signal", s=>{
    sendTG({t:"offer", from:id, connId:cid, signal:s});
  });

  p.on("connect", ()=>log("âœ… connected " + cid));
  p.on("data", d=>log("ğŸ’¬ " + d));
}

function answerOffer(o){
  const p = new SimplePeer({initiator:false,trickle:false});
  peers[o.connId] = p;

  p.on("signal", s=>{
    sendTG({t:"answer", from:id, connId:o.connId, signal:s});
  });

  p.on("connect", ()=>log("âœ… connected " + o.connId));
  p.on("data", d=>log("ğŸ’¬ " + d));

  p.signal(o.signal);
}

/* ===== BEACON ===== */
function toggleBeacon(){
  beaconOn = !beaconOn;
  const btn = document.getElementById("beaconBtn");

  if(beaconOn){
    btn.textContent = "ğŸ“¡ Pusat Node: ON";
    btn.classList.remove("off");
    log("ğŸŸ¢ Beacon ON");
    helloTimer = setInterval(sendHello, HELLO_INTERVAL);
    sendHello();
  }else{
    btn.textContent = "ğŸ“¡ Pusat Node: OFF";
    btn.classList.add("off");
    log("âšª Beacon OFF");
    clearInterval(helloTimer);
  }
}

function sendHello(){
  sendTG({t:"hello", from:id, ts:Date.now()});
}

/* ===== POLLING ===== */
async function poll(){
  const r = await fetch(
    `https://api.telegram.org/bot${BOT_READ}/getUpdates?offset=${lastUpdate+1}`
  );
  const j = await r.json();
  if(!j.result) return;

  j.result.forEach(u=>{
    lastUpdate = u.update_id;
    const m = u.channel_post || u.message;
    if(!m?.text) return;

    try{
      const o = JSON.parse(m.text);
      if(o.from === id) return;

      if(o.t === "hello"){
        // node biasa â†’ buat offer ke beacon
        if(!beaconOn && Object.keys(peers).length < 5){
          makeOffer();
        }
      }

      if(o.t === "offer"){
        if(!peers[o.connId]){
          answerOffer(o);
        }
      }

      if(o.t === "answer"){
        const p = peers[o.connId];
        if(p) p.signal(o.signal);
      }
    }catch{}
  });
}

/* ===== CHAT ===== */
function sendMsg(){
  const v = msg.value;
  for(const k in peers){
    if(peers[k].connected) peers[k].send(v);
  }
  log("me: " + v);
  msg.value="";
}

/* ===== START ===== */
setInterval(poll, POLL_INTERVAL);
</script>

</body>
</html>